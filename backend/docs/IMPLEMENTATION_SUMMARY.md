# üìã T·ªïng k·∫øt Implementation - Wallet & Payment Integration

## ‚úÖ ƒê√£ ho√†n th√†nh

### 1. Schema Design ‚úÖ

#### Wallet Schema (`backend/src/wallet/schemas/wallet.schema.ts`)
- H·ªó tr·ª£ multi-actor: customer, restaurant, driver, admin
- C√°c tr∆∞·ªùng: balance, pendingBalance, totalDeposits, totalWithdrawals
- Indexes ƒë·ªÉ query nhanh
- System wallet cho platform

#### WalletTransaction Schema (`backend/src/wallet/schemas/wallet-transaction.schema.ts`)
- Types: deposit, withdraw, order_payment, order_revenue, commission, platform_fee, refund
- MoMo integration fields: providerTransactionId, providerPaymentUrl, providerCallback
- Status: pending, completed, failed, cancelled
- Reference ƒë·∫øn order n·∫øu c√≥

### 2. Service Layer ‚úÖ

#### MomoService (`backend/src/payment/momo.service.ts`)
- `createPaymentUrl()` - T·∫°o MoMo payment URL
- `verifyCallback()` - Verify signature t·ª´ MoMo
- `queryPaymentStatus()` - Query status
- Environment: test/production

#### WalletService (`backend/src/wallet/wallet.service.ts`)
- `getWalletForActor()` - Get/create wallet cho actor
- `depositViaProvider()` - N·∫°p ti·ªÅn v·ªõi provider
- `withdrawFromWallet()` - R√∫t ti·ªÅn
- `confirmDeposit()` - X√°c nh·∫≠n n·∫°p t·ª´ callback
- `distributeOrderEarnings()` - Ph√¢n chia ti·ªÅn khi ƒë∆°n delivered
- `updateTransactionProviderUrl()` - Update payment URL

### 3. Controller Layer ‚úÖ

#### PaymentController (`backend/src/payment/payment.controller.ts`)
- `POST /payment/deposit` - N·∫°p ti·ªÅn v√†o v√≠
- `POST /payment/withdraw` - R√∫t ti·ªÅn t·ª´ v√≠
- `POST /payment/order` - Thanh to√°n ƒë∆°n h√†ng
- `POST /payment/momo/callback` - MoMo callback handler
- `GET /payment/:transactionId` - L·∫•y th√¥ng tin giao d·ªãch

#### WalletController (`backend/src/wallet/wallet.controller.ts`)
- `GET /wallet/balance` - L·∫•y s·ªë d∆∞
- `GET /wallet/transactions` - L·ªãch s·ª≠ giao d·ªãch
- `POST /wallet/deposit` - N·∫°p ti·ªÅn (legacy)
- `POST /wallet/withdraw` - R√∫t ti·ªÅn (legacy)

### 4. Module Setup ‚úÖ

#### PaymentModule (`backend/src/payment/payment.module.ts`)
- Import WalletModule
- Register PaymentController
- Export MomoService

#### WalletModule (`backend/src/wallet/wallet.module.ts`)
- Register WalletController
- Export WalletService

### 5. Documentation ‚úÖ

#### WALLET_PAYMENT_API.md
- API endpoints documentation
- Request/Response examples
- Database schema
- Complete payment flow

#### PAYMENT_INTEGRATION.md
- Architecture overview
- Complete payment flow diagrams
- Money distribution logic
- Database collections
- Implementation checklist

#### DTOs (`backend/src/payment/dto/payment.dto.ts`)
- DepositDto, WithdrawDto, OrderPaymentDto
- Validation rules

---

## üöß C·∫ßn ho√†n th√†nh

### 1. T√≠ch h·ª£p v·ªõi Order Module (TODO)

C·∫ßn th√™m v√†o `OrderService`:

```typescript
// backend/src/order/order.service.ts

import { WalletService } from '../wallet/wallet.service';

@Injectable()
export class OrderService {
  constructor(
    private walletService: WalletService,
    // ...
  ) {}

  /**
   * T·∫°o ƒë∆°n h√†ng - t·ª± ƒë·ªông thanh to√°n n·∫øu paymentMethod = 'momo'
   */
  async createOrder(createOrderDto: CreateOrderDto, customerId: string) {
    // 1. Create order
    const order = await this.orderModel.create({...});
    
    // 2. N·∫øu paymentMethod = 'momo', t·∫°o payment transaction
    if (order.paymentMethod === 'momo') {
      await this.initiateOrderPayment(order);
    }
    
    return order;
  }

  /**
   * Kh·ªüi t·∫°o thanh to√°n cho ƒë∆°n h√†ng
   */
  private async initiateOrderPayment(order: any) {
    // 1. L·∫•y payment URL t·ª´ MoMo
    const paymentUrl = await this.paymentService.createPaymentUrl(...);
    
    // 2. T·∫°o transaction record
    const transaction = await this.walletService.depositViaProvider(
      'customer',
      order.customerId,
      order.finalTotal,
      'momo',
      order._id.toString()
    );
    
    // 3. Return payment URL ƒë·ªÉ Frontend redirect
    return paymentUrl;
  }

  /**
   * C·∫≠p nh·∫≠t status ƒë∆°n h√†ng
   */
  async updateOrderStatus(orderId: string, status: OrderStatus) {
    const order = await this.orderModel.findByIdAndUpdate(orderId, { status });
    
    // N·∫øu ƒë∆°n DELIVERED ‚Üí t·ª± ƒë·ªông ph√¢n chia ti·ªÅn
    if (status === OrderStatus.DELIVERED) {
      await this.distributeOrderEarnings(order);
    }
    
    return order;
  }

  /**
   * Ph√¢n chia ti·ªÅn khi ƒë∆°n delivered
   */
  private async distributeOrderEarnings(order: any) {
    // Calculate earnings
    const restaurantRevenue = order.subtotal - order.platformFee;
    const driverPayment = order.deliveryFee + order.tip;
    const platformFee = order.platformFeeAmount;
    
    // Update order with earnings
    await this.orderModel.findByIdAndUpdate(order._id, {
      restaurantRevenue,
      driverPayment,
      platformFeeAmount: platformFee
    });
    
    // Distribute
    await this.walletService.distributeOrderEarnings(order);
  }
}
```

### 2. Frontend Integration (TODO)

C·∫ßn t·∫°o c√°c components/pages:

```typescript
// frontend/src/app/customer/wallet/page.tsx
- Wallet balance display
- Deposit button
- Withdraw button
- Transaction history list

// frontend/src/app/customer/checkout/page.tsx
- Order review
- Payment method selection
- MoMo payment button
- Redirect to MoMo

// frontend/src/components/WalletBalance.tsx
- Display current balance
- Display pending balance
- Quick deposit button

// frontend/src/services/wallet.service.ts
- deposit(amount, provider)
- withdraw(amount, provider, phoneNumber)
- getBalance()
- getTransactions()
```

### 3. Environment Variables (TODO)

```bash
# Th√™m v√†o backend/.env

# MoMo Configuration
MOMO_PARTNER_CODE=MOMO
MOMO_ACCESS_KEY=F8BBA842ECF85
MOMO_SECRET_KEY=K951B6PE1waDMi640xX08PD3vg6EkVlz
MOMO_REDIRECT_URL=http://localhost:3002/customer/wallet/success
MOMO_IPN_URL=http://localhost:3001/api/v1/payment/momo/callback
MOMO_ENV=test
```

### 4. Testing (TODO)

```bash
# Test deposit flow
curl -X POST http://localhost:3001/api/v1/payment/deposit \
  -H "Authorization: Bearer <customer_token>" \
  -H "Content-Type: application/json" \
  -d '{"amount": 100000, "provider": "momo", "ownerType": "customer"}'

# Test withdraw flow
curl -X POST http://localhost:3001/api/v1/payment/withdraw \
  -H "Authorization: Bearer <restaurant_token>" \
  -H "Content-Type: application/json" \
  -d '{"amount": 50000, "provider": "momo", "phoneNumber": "0937123456"}'

# Test order payment
curl -X POST http://localhost:3001/api/v1/payment/order \
  -H "Authorization: Bearer <customer_token>" \
  -H "Content-Type: application/json" \
  -d '{"orderId": "order_id", "amount": 150000, "orderCode": "ORD001", "restaurantId": "rest_id"}'

# Test MoMo callback
curl -X POST http://localhost:3001/api/v1/payment/momo/callback \
  -H "Content-Type: application/json" \
  -d '{"orderId": "test", "resultCode": 0, "amount": 100000, "signature": "..."}'
```

---

## üéØ Lu·ªìng ho√†n ch·ªânh

### Customer n·∫°p ti·ªÅn:

```
1. Frontend: User click "N·∫°p ti·ªÅn"
2. POST /payment/deposit ‚Üí Backend
3. Backend t·∫°o transaction (pending)
4. Backend g·ªçi MoMo API ‚Üí nh·∫≠n paymentUrl
5. Response paymentUrl v·ªÅ Frontend
6. Frontend redirect user ƒë·∫øn MoMo
7. User thanh to√°n tr√™n MoMo
8. MoMo g·ªçi callback: POST /payment/momo/callback
9. Backend verify signature
10. Backend update transaction (completed)
11. Backend credit v√†o v√≠
12. Response success v·ªÅ MoMo
```

### Thanh to√°n ƒë∆°n h√†ng:

```
1. Customer ƒë·∫∑t ƒë∆°n ‚Üí POST /orders
2. N·∫øu paymentMethod = 'momo':
   - T·∫°o order v·ªõi status: 'pending'
   - POST /payment/order ‚Üí T·∫°o payment transaction
   - Nh·∫≠n paymentUrl t·ª´ MoMo
   - Redirect customer ƒë·∫øn MoMo
3. Customer thanh to√°n tr√™n MoMo
4. MoMo callback ‚Üí Update transaction & order
5. Order status = 'confirmed'
6. Restaurant chu·∫©n b·ªã ‚Üí Order status = 'ready'
7. Driver nh·∫≠n ƒë∆°n ‚Üí Order status = 'picked_up'
8. Driver giao ‚Üí Order status = 'delivered'
9. Auto distribute:
   - Restaurant nh·∫≠n ti·ªÅn
   - Driver nh·∫≠n commission
   - Platform thu ph√≠
```

---

## üìä Database Summary

### Collections c·∫ßn c√≥:

1. **wallets** - L∆∞u th√¥ng tin v√≠ c·ªßa c√°c actors
2. **wallet_transactions** - L∆∞u l·ªãch s·ª≠ giao d·ªãch
3. **orders** - C·∫ßn th√™m fields: restaurantRevenue, driverPayment, platformFeeAmount

### Indexes t·ªëi ∆∞u:

```javascript
// wallets
db.wallets.createIndex({ userId: 1, ownerType: 1 });
db.wallets.createIndex({ restaurantId: 1, ownerType: 1 });
db.wallets.createIndex({ driverId: 1, ownerType: 1 });
db.wallets.createIndex({ isSystemWallet: 1 });

// wallet_transactions
db.wallet_transactions.createIndex({ walletId: 1, createdAt: -1 });
db.wallet_transactions.createIndex({ userId: 1, status: 1 });
db.wallet_transactions.createIndex({ restaurantId: 1, status: 1 });
db.wallet_transactions.createIndex({ driverId: 1, status: 1 });
db.wallet_transactions.createIndex({ orderId: 1 });
db.wallet_transactions.createIndex({ providerTransactionId: 1 });
```

---

## üöÄ Deployment Checklist

- [ ] Setup MoMo production credentials
- [ ] Configure SSL certificate cho callback URL
- [ ] Add IP whitelist trong MoMo dashboard
- [ ] Test with MoMo sandbox tr∆∞·ªõc
- [ ] Monitor callback logs
- [ ] Setup error alerts
- [ ] Backup database tr∆∞·ªõc khi deploy
- [ ] Document API endpoints
- [ ] Setup API rate limiting
- [ ] Configure CORS properly

---

## üìù Notes quan tr·ªçng

1. **Security**: Lu√¥n verify signature trong MoMo callback
2. **Idempotency**: X·ª≠ l√Ω duplicate callbacks t·ª´ MoMo
3. **Error Handling**: Log m·ªçi errors v√† transactions
4. **Testing**: Test ƒë·∫ßy ƒë·ªß v·ªõi MoMo sandbox
5. **Monitoring**: Monitor payment success rate v√† errors
6. **Logging**: Log t·∫•t c·∫£ payment transactions ƒë·ªÉ audit
7. **Refund**: Implement refund n·∫øu c·∫ßn h·ªßy ƒë∆°n

---

## üîó File Structure

```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ payment/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ momo.service.ts          ‚úÖ MoMo integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment.controller.ts     ‚úÖ Payment endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment.module.ts         ‚úÖ Module setup
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payment.schema.ts     ‚úÖ Payment schema
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ payment.dto.ts         ‚úÖ DTOs
‚îÇ   ‚îî‚îÄ‚îÄ wallet/
‚îÇ       ‚îú‚îÄ‚îÄ wallet.service.ts        ‚úÖ All wallet methods
‚îÇ       ‚îú‚îÄ‚îÄ wallet.controller.ts     ‚úÖ Wallet endpoints
‚îÇ       ‚îú‚îÄ‚îÄ wallet.module.ts          ‚úÖ Module setup
‚îÇ       ‚îú‚îÄ‚îÄ schemas/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ wallet.schema.ts      ‚úÖ Wallet schema
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ wallet-transaction.schema.ts ‚úÖ Transaction schema
‚îÇ       ‚îî‚îÄ‚îÄ dto/
‚îÇ           ‚îî‚îÄ‚îÄ wallet-operation.dto.ts ‚úÖ DTOs
‚îî‚îÄ‚îÄ docs/
    ‚îú‚îÄ‚îÄ WALLET_PAYMENT_API.md         ‚úÖ API docs
    ‚îú‚îÄ‚îÄ PAYMENT_INTEGRATION.md         ‚úÖ Integration guide
    ‚îî‚îÄ‚îÄ IMPLEMENTATION_SUMMARY.md     ‚úÖ This file
```

---

## ‚úÖ K·∫øt lu·∫≠n

**ƒê√£ ho√†n th√†nh:**
- ‚úÖ Wallet & Transaction schemas
- ‚úÖ MomoService integration
- ‚úÖ WalletService v·ªõi ƒë·∫ßy ƒë·ªß methods
- ‚úÖ PaymentController v·ªõi c√°c endpoints
- ‚úÖ Documentation ƒë·∫ßy ƒë·ªß

**C·∫ßn l√†m ti·∫øp:**
- ‚è≥ T√≠ch h·ª£p v·ªõi OrderService
- ‚è≥ Frontend implementation
- ‚è≥ Testing v·ªõi MoMo sandbox
- ‚è≥ Production deployment

**Thi·∫øt k·∫ø t·ªïng th·ªÉ: ‚úÖ Ph√π h·ª£p v·ªõi y√™u c·∫ßu**

